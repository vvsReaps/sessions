<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sessions | Reaps</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f1115; --muted:#9aa0a6; --card:#151923; --ring:#202637; --text:#e6e9ef;
            --asia:#3b82f6; --london:#22c55e; --ny:#ef4444; --closed:#6b7280;
            --pre:#a78bfa; --regular:#f59e0b; --post:#06b6d4;
            --macro1:#f97316; --macro2:#eab308; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;
         background:radial-gradient(1200px 800px at 50% -10%,#1b2130 0%,var(--bg) 55%);
         color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .wrap{width:100%;max-width:980px}
    h1{margin:0 0 8px;font-weight:700;letter-spacing:.2px;font-size:clamp(24px,3.2vw,36px);text-align:center}
    .sub{color:var(--muted);text-align:center;margin-bottom:12px;font-size:14px}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--ring);background:rgba(255,255,255,.03)}
    .banner{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:10px 0 18px}
    .status{border:1px dashed var(--ring);background:rgba(255,255,255,.03);padding:8px 10px;border-radius:10px;font-size:13px}
    .status.primary{
      font-size: clamp(18px, 2.8vw, 32px);
      font-weight: 800;
      padding: 12px 16px;
      border-width: 2px;
      letter-spacing: .2px;
    }
    .section{margin:22px 0 10px;font-weight:800;letter-spacing:.3px;color:#cbd5e1;text-transform:uppercase;font-size:12px;opacity:.9}
    .strong{font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px}
    .grid.two{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:860px){.grid,.grid.two{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0) 40%),var(--card);
          border:1px solid var(--ring);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05)}
    .head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
    .title{display:flex;align-items:center;gap:10px;font-weight:700;font-size:18px}
    .dot{width:12px;height:12px;border-radius:50%;box-shadow:0 0 0 3px rgba(255,255,255,.05) inset}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;letter-spacing:.3px;border:1px solid var(--ring);background:rgba(255,255,255,.03)}
    .label{color:var(--muted);font-size:12px;margin-bottom:10px}
    .timer{font-variant-numeric:tabular-nums;font-size:28px;font-weight:800;letter-spacing:.5px;margin:6px 0 12px}
    .bar{height:10px;width:100%;background:#0e1320;border:1px solid var(--ring);border-radius:999px;overflow:hidden}
    .fill{height:100%;width:0%;transition:width .6s ease}
    .row{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted);margin-top:10px}
    .asia .dot,.asia .fill{background:var(--asia)}
    .london .dot,.london .fill{background:var(--london)}
    .newyork .dot,.newyork .fill{background:var(--ny)}
    .closed .dot{background:var(--closed)}
    .pre .dot,.pre .fill{background:var(--pre)}
    .regular .dot,.regular .fill{background:var(--regular)}
    .post .dot,.post .fill{background:var(--post)}
    .macro830 .dot,.macro830 .fill{background:var(--macro1)}
    .macro1000 .dot,.macro1000 .fill{background:var(--macro2)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Trading Sessions â€” Live</h1>

    <div class="banner">
      <div class="status" id="lullStatus">â€”</div>
      <div class="status" id="maintStatus">â€”</div>
    </div>

    <div class="section">Global FX Sessions</div>
    <div class="grid">
      <div class="card asia" id="asiaCard">
        <div class="head"><div class="title"><span class="dot"></span> Asia</div><div class="badge" id="asiaStatus">â€”</div></div>
        <div class="label" id="asiaLabel">â€”</div>
        <div class="timer" id="asiaTimer">--:--:--</div>
        <div class="bar"><div class="fill" id="asiaFill"></div></div>
        <div class="row"><span>Open: <strong id="asiaOpenET"></strong></span><span>Close: <strong id="asiaCloseET"></strong></span></div>
      </div>

      <div class="card london" id="londonCard">
        <div class="head"><div class="title"><span class="dot"></span> London</div><div class="badge" id="londonStatus">â€”</div></div>
        <div class="label" id="londonLabel">â€”</div>
        <div class="timer" id="londonTimer">--:--:--</div>
        <div class="bar"><div class="fill" id="londonFill"></div></div>
        <div class="row"><span>Open: <strong id="londonOpenET"></strong></span><span>Close: <strong id="londonCloseET"></strong></span></div>
      </div>

      <div class="card newyork" id="nyCard">
        <div class="head"><div class="title"><span class="dot"></span> New York</div><div class="badge" id="nyStatus">â€”</div></div>
        <div class="label" id="nyLabel">â€”</div>
        <div class="timer" id="nyTimer">--:--:--</div>
        <div class="bar"><div class="fill" id="nyFill"></div></div>
        <div class="row"><span>Open: <strong id="nyOpenET"></strong></span><span>Close: <strong id="nyCloseET"></strong></span></div>
      </div>
    </div>

    <div class="section">US Equity (Retail) Sessions</div>
    <div class="grid">
      <div class="card pre" id="preCard">
        <div class="head"><div class="title"><span class="dot"></span> Pre-Market</div><div class="badge" id="preStatus">â€”</div></div>
        <div class="label" id="preLabel">â€”</div>
        <div class="timer" id="preTimer">--:--:--</div>
        <div class="bar"><div class="fill" id="preFill"></div></div>
        <div class="row"><span>Open: <strong id="preOpenET"></strong></span><span>Close: <strong id="preCloseET"></strong></span></div>
      </div>

      <div class="card regular" id="regularCard">
        <div class="head"><div class="title"><span class="dot"></span> Regular</div><div class="badge" id="regularStatus">â€”</div></div>
        <div class="label" id="regularLabel">â€”</div>
        <div class="timer" id="regularTimer">--:--:--</div>
        <div class="bar"><div class="fill" id="regularFill"></div></div>
        <div class="row"><span>Open: <strong id="regularOpenET"></strong></span><span>Close: <strong id="regularCloseET"></strong></span></div>
      </div>

      <div class="card post" id="postCard">
        <div class="head"><div class="title"><span class="dot"></span> After-Hours</div><div class="badge" id="postStatus">â€”</div></div>
        <div class="label" id="postLabel">â€”</div>
        <div class="timer" id="postTimer">--:--:--</div>
        <div class="bar"><div class="fill" id="postFill"></div></div>
        <div class="row"><span>Open: <strong id="postOpenET"></strong></span><span>Close: <strong id="postCloseET"></strong></span></div>
      </div>
    </div>

    <div class="section">Macro Windows (Typical US Releases)</div>
    <div class="grid two">
      <div class="card macro830" id="macro830Card">
        <div class="head"><div class="title"><span class="dot"></span> 08:30 Data Window</div><div class="badge" id="macro830Status">â€”</div></div>
        <div class="label" id="macro830Label">â€”</div>
        <div class="timer" id="macro830Timer">--:--:--</div>
        <div class="bar"><div class="fill" id="macro830Fill"></div></div>
        <div class="row"><span>Open: <strong id="macro830OpenET"></strong></span><span>Close: <strong id="macro830CloseET"></strong></span></div>
      </div>

      <div class="card macro1000" id="macro1000Card">
        <div class="head"><div class="title"><span class="dot"></span> 10:00 Data Window</div><div class="badge" id="macro1000Status">â€”</div></div>
        <div class="label" id="macro1000Label">â€”</div>
        <div class="timer" id="macro1000Timer">--:--:--</div>
        <div class="bar"><div class="fill" id="macro1000Fill"></div></div>
        <div class="row"><span>Open: <strong id="macro1000OpenET"></strong></span><span>Close: <strong id="macro1000CloseET"></strong></span></div>
      </div>
    </div>
  </div>

  <!-- Test Sound Button (floating, unobtrusive) -->
  <button id="testSoundBtn"
    style="position:fixed;bottom:20px;right:20px;z-index:999;
           background:#2563eb;color:white;font-weight:600;
           border:none;border-radius:999px;padding:12px 18px;
           box-shadow:0 4px 12px rgba(0,0,0,.3);cursor:pointer;">
    Test Sound
  </button>

  <script>
    // ===== SETTINGS =====
    const DISPLAY_TZ = 'America/New_York';
    const USE_FIXED_EST = false;       // set true to force fixed UTC-5
    const FIXED_EST_TZ = 'Etc/GMT+5';

    // FX Sessions in ET
    const SESSIONS_ET = [
      { id:'asia',   name:'Asia',     openET:19*60, closeET:4*60,  wraps:true  },
      { id:'london', name:'London',   openET:3*60,  closeET:12*60, wraps:false },
      { id:'ny',     name:'New York', openET:8*60,  closeET:17*60, wraps:false }
    ];

    // Retail (US equities) in ET
    const RETAIL_ET = [
      { id:'pre',     name:'Pre-Market', openET:4*60,           closeET:9*60+30,  wraps:false },
      { id:'regular', name:'Regular',    openET:9*60+30,        closeET:16*60,    wraps:false },
      { id:'post',    name:'After-Hours',openET:16*60,          closeET:20*60,    wraps:false }
    ];

    // Macro windows (typical US release times) â€” weekdays only
    const MACRO_WINDOWS = [
      { id:'macro830',  name:'08:30 Data', openET:8*60+30,  closeET:9*60+30,  wraps:false },
      { id:'macro1000', name:'10:00 Data', openET:10*60,    closeET:10*60+10, wraps:false }
    ];

    // Maintenance (FX): 17:00â€“18:00 ET
    const MAINT_START_ET = 17*60;
    const MAINT_END_ET   = 18*60;

    // Weekend closed (FX & Retail baseline): Fri 17:00 ET â†’ Sun 17:00 ET
    const DOW = { Sun:0, Mon:1, Tue:2, Wed:3, Thu:4, Fri:5, Sat:6 };

    // ===== AUDIO ALERTS =====
    const SOUND_ENABLED = true;
    let audioCtx = null;
    const prevStates = { asia:null, london:null, ny:null, pre:null, regular:null, post:null, macro830:null, macro1000:null };

    function getAudioCtx() {
      if (audioCtx) return audioCtx;
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if (!Ctx) return null;
      audioCtx = new Ctx();
      return audioCtx;
    }
    async function resumeAudioCtx() {
      const ctx = getAudioCtx();
      if (!ctx) return false;
      if (ctx.state === 'suspended') { try { await ctx.resume(); } catch {} }
      return ctx.state === 'running';
    }
    function playToneOnce(ctx, { freq=880, ms=180, type='sine', gain=50 }={}) {
      const osc = ctx.createOscillator(); const g = ctx.createGain();
      osc.type = type; osc.frequency.value = freq; g.gain.value = gain;
      osc.connect(g).connect(ctx.destination);
      const t0 = ctx.currentTime;
      g.gain.setValueAtTime(0, t0);
      g.gain.linearRampToValueAtTime(gain, t0 + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + ms/1000);
      osc.start(t0); osc.stop(t0 + ms/1000 + 0.02);
    }
    async function playTone(freq = 880, durationMs = 180, type = 'sine', gain = 50) {
      if (!SOUND_ENABLED) return;
      const ok = await resumeAudioCtx(); if (!ok) return;
      playToneOnce(audioCtx, { freq, ms: durationMs, type, gain });
    }
    function chimeOpen(){ playTone(880,140,'sine',50); setTimeout(()=>playTone(1175,160,'sine',0.06),170); }
    function beepClose(){ playTone(440,180,'sine',50); }
    function maybeAlert(sessionId, isOpenNow) {
      const prev = prevStates[sessionId];
      if (prev === null) { prevStates[sessionId] = isOpenNow; return; }
      if (prev !== isOpenNow) { if (isOpenNow) chimeOpen(); else beepClose(); prevStates[sessionId] = isOpenNow; }
    }

    // Unlock / resume audio on user gesture
    async function unlockAudio() {
      const ok = await resumeAudioCtx(); if (!ok) return;
      try { playToneOnce(audioCtx, { freq: 600, ms: 50, gain: 0.005 }); } catch {}
      ['pointerdown','touchstart','mousedown','keydown'].forEach(ev =>
        window.removeEventListener(ev, unlockAudio, { passive: true })
      );
    }
    ['pointerdown','touchstart','mousedown','keydown'].forEach(ev =>
      window.addEventListener(ev, unlockAudio, { passive: true, once: false })
    );
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') { resumeAudioCtx(); }
    });

    // ===== HELPERS =====
    const pad2 = n => n.toString().padStart(2,'0');
    const fmtHMS = ms => {
      const s = Math.max(0, Math.floor(ms/1000));
      const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), ss = s%60;
      return `${pad2(h)}:${pad2(m)}:${pad2(ss)}`;
    };
    const tzForDisplay = () => USE_FIXED_EST ? FIXED_EST_TZ : DISPLAY_TZ;

    function partsInTZ(date, tz){
      return new Intl.DateTimeFormat('en-US', {
        timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit',
        weekday:'short', hour12:false
      }).formatToParts(date).reduce((a,p)=>{ a[p.type]=p.value; return a; }, {});
    }
    function etSeconds(date, tz){ const p=partsInTZ(date,tz); return (+p.hour)*3600+(+p.minute)*60+(+p.second); }
    function etMinutes(date, tz){ return etSeconds(date, tz)/60; }
    function etWeekdayIndex(date, tz){ const wd = partsInTZ(date, tz).weekday; return DOW[wd]; }
    function formatETLabel(mins){
      const h=Math.floor(((mins%1440)+1440)%1440/60);
      const m=Math.floor(((mins%60)+60)%60);
      const abbr=new Intl.DateTimeFormat([], { timeZone: tzForDisplay(), timeZoneName: 'short' })
                 .format(new Date()).split(' ').pop();
      return `${pad2(h)}:${pad2(m)} ${abbr}`;
    }
    function minutesUntilDOW(nowDayIdx, nowMins, targetDayIdx, targetMins){
      let dayDelta=(targetDayIdx-nowDayIdx+7)%7;
      if(dayDelta===0 && targetMins<=nowMins) dayDelta=7;
      return dayDelta*1440 + (targetMins-nowMins);
    }
    function msUntilFromET(nowSecs, minutesAhead){ return Math.max(0, minutesAhead)*60*1000; }

    // Core math (handles wrap-around sessions)
    function sessionStateET(nowMinET, openET, closeET, wraps){
      const inOpen = wraps ? (nowMinET>=openET || nowMinET<closeET)
                           : (nowMinET>=openET && nowMinET<closeET);
      let nextChangeMin, prevChangeMin, windowStart, windowEnd;
      if (inOpen){
        nextChangeMin = wraps ? (nowMinET>=openET ? 24*60+closeET : closeET) : closeET;
        prevChangeMin = wraps ? (nowMinET>=openET ? openET : openET-24*60)    : openET;
        windowStart = prevChangeMin; windowEnd = nextChangeMin;
      } else {
        const nextOpen  = (wraps && nowMinET<closeET) ? openET : (nowMinET<openET ? openET : 24*60+openET);
        const lastClose = (wraps && nowMinET>=closeET && nowMinET<openET) ? closeET : (nowMinET>=closeET ? closeET : closeET-24*60);
        nextChangeMin = nextOpen; prevChangeMin = lastClose;
        windowStart = nextOpen; windowEnd = wraps ? (nextOpen<closeET ? closeET : 24*60+closeET)
                                                  : (nextOpen + (closeET-openET));
      }
      return { isOpen: inOpen, nextChangeMin, prevChangeMin, windowStart, windowEnd };
    }

    function isWeekendClosed(nowDayIdx, nowMinET){
      if (nowDayIdx===DOW.Fri && nowMinET>=17*60) return true;
      if (nowDayIdx===DOW.Sat) return true;
      if (nowDayIdx===DOW.Sun && nowMinET<17*60) return true;
      return false;
    }
    function isWeekday(dayIdx){ return dayIdx!==DOW.Sat && dayIdx!==DOW.Sun; }

    // ===== RENDER =====
    function updateUI(){
      const now = new Date();
      const tz = tzForDisplay();
      const utcNow = new Date(now.getTime()+now.getTimezoneOffset()*60000);
      const etSecs = etSeconds(now, tz);
      const etMins = etSecs/60;
      const dayIdx = etWeekdayIndex(now, tz);
      const tzShort = new Intl.DateTimeFormat([], { timeZone: tz, timeZoneName:'short' }).format(now).split(' ').pop();

      // header
      document.getElementById('localNow').textContent = now.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit', second:'2-digit' });
      document.getElementById('utcNow').textContent   = `${pad2(utcNow.getUTCHours())}:${pad2(utcNow.getUTCMinutes())}:${pad2(utcNow.getUTCSeconds())}`;
      document.getElementById('etNow').textContent    = new Intl.DateTimeFormat([], { timeZone: tz, hour:'2-digit', minute:'2-digit', second:'2-digit' }).format(now);
      document.getElementById('tzLabel').textContent  = USE_FIXED_EST ? 'EST (fixed UTC-5)' : `ET (${tzShort})`;

      // session window pills (FX)
      document.getElementById('asiaWindow').textContent   = `Asia ${formatETLabel(19*60)}â€“${formatETLabel(4*60)}`;
      document.getElementById('londonWindow').textContent = `London ${formatETLabel(3*60)}â€“${formatETLabel(12*60)}`;
      document.getElementById('nyWindow').textContent     = `New York ${formatETLabel(8*60)}â€“${formatETLabel(17*60)}`;

      // retail pills
      document.getElementById('preWindow').textContent     = `Pre ${formatETLabel(4*60)}â€“${formatETLabel(9*60+30)}`;
      document.getElementById('regularWindow').textContent = `Regular ${formatETLabel(9*60+30)}â€“${formatETLabel(16*60)}`;
      document.getElementById('postWindow').textContent    = `After ${formatETLabel(16*60)}â€“${formatETLabel(20*60)}`;

      // macro pills
      document.getElementById('macro830Window').textContent  = `Macro ${formatETLabel(8*60+30)}â€“${formatETLabel(9*60+30)}`;
      document.getElementById('macro1000Window').textContent = `Macro ${formatETLabel(10*60)}â€“${formatETLabel(10*60+10)}`;

      const weekend = isWeekendClosed(dayIdx, etMins);
      const lullEl  = document.getElementById('lullStatus');
      const maintEl = document.getElementById('maintStatus');

      // ----- Banner: FX open/closed + maintenance -----
      if (weekend){
        const minsToAsiaSun = minutesUntilDOW(dayIdx, etMins, DOW.Sun, 19*60);
        lullEl.innerHTML = `<span class="strong">Weekend â€” market closed</span> Â· Asia opens in <span class="strong">${fmtHMS(msUntilFromET(etSecs, minsToAsiaSun))}</span>`;
        lullEl.classList.add('primary');
        const minsToMaintMon = minutesUntilDOW(dayIdx, etMins, DOW.Mon, 17*60);
        maintEl.innerHTML = `ðŸ”§ Maintenance resumes ${formatETLabel(17*60)} Mon Â· starts in <span class="strong">${fmtHMS(msUntilFromET(etSecs, minsToMaintMon))}</span>`;
      } else {
        const openNow = [];
        SESSIONS_ET.forEach(s => {
          const st = sessionStateET(etMins, s.openET, s.closeET, s.wraps);
          if (st.isOpen) openNow.push(s.name);
        });
        const betweenSessions = (etMins >= 18*60 && etMins < 19*60);
        if (openNow.length === 0){
          let best = Infinity, who = '';
          SESSIONS_ET.forEach(s => {
            const st = sessionStateET(etMins, s.openET, s.closeET, s.wraps);
            const mins = st.nextChangeMin - etMins < 0 ? (st.nextChangeMin - etMins + 1440) : (st.nextChangeMin - etMins);
            if (mins < best){ best = mins; who = s.name; }
          });
          if (betweenSessions){
            lullEl.innerHTML = `<span class="strong">Market OPEN â€” Between Sessions</span> Â· Asia session begins in <span class="strong">${fmtHMS(msUntilFromET(etSecs, best))}</span>`;
          } else {
            lullEl.innerHTML = `<span class="strong">Market Closed</span> â€” no sessions open Â· ${who} opens in <span class="strong">${fmtHMS(msUntilFromET(etSecs, best))}</span>`;
          }
          lullEl.classList.add('primary');
        } else {
          lullEl.innerHTML = `<span class="strong">Open now</span>: ${openNow.join(' Â· ')}`;
          lullEl.classList.add('primary');
        }

        const inMaint = etMins >= MAINT_START_ET && etMins < MAINT_END_ET;
        if (inMaint){
          maintEl.innerHTML = `ðŸ”§ <span class="strong">Maintenance / Rollover</span> ${formatETLabel(MAINT_START_ET)}â€“${formatETLabel(MAINT_END_ET)} Â· ends in <span class="strong">${fmtHMS(msUntilFromET(etSecs, MAINT_END_ET - etMins))}</span>`;
        } else {
          const nextStart = etMins < MAINT_START_ET ? MAINT_START_ET : (24*60 + MAINT_START_ET);
          maintEl.innerHTML = `ðŸ”§ Maintenance ${formatETLabel(MAINT_START_ET)}â€“${formatETLabel(MAINT_END_ET)} Â· starts in <span class="strong">${fmtHMS(msUntilFromET(etSecs, nextStart - etMins))}</span>`;
        }
      }

      // ----- Render helper -----
      function renderCard(def, weekendOverride, weekdayOnly=false){
        const statusEl = document.getElementById(`${def.id}Status`);
        const labelEl  = document.getElementById(`${def.id}Label`);
        const timerEl  = document.getElementById(`${def.id}Timer`);
        const fillEl   = document.getElementById(`${def.id}Fill`);
        const cardEl   = document.getElementById(`${def.id}Card`);
        const openEl   = document.getElementById(`${def.id}OpenET`);
        const closeEl  = document.getElementById(`${def.id}CloseET`);

        if (openEl)  openEl.textContent  = formatETLabel(def.openET);
        if (closeEl) closeEl.textContent = formatETLabel(def.closeET);

        // If flagged weekday-only (macro), force closed on weekends
        const forceClosedToday = weekendOverride || (weekdayOnly && !isWeekday(dayIdx));

        if (forceClosedToday){
          // Decide the next target (Mon or Sun depending on type)
          let targetDay = DOW.Mon;
          if (def.id === 'macro830' || def.id === 'macro1000' || def.id === 'pre' || def.id === 'regular' || def.id === 'post'){
            targetDay = DOW.Mon;
          } else if (def.id === 'asia'){ targetDay = DOW.Sun; }

          const minsAhead = minutesUntilDOW(dayIdx, etMins, targetDay, def.openET);
          maybeAlert(def.id, false);
          statusEl.textContent = 'CLOSED';
          labelEl.textContent  = 'Opens in';
          timerEl.textContent  = fmtHMS(msUntilFromET(etSecs, minsAhead));
          if (fillEl) fillEl.style.width = '0%';
          cardEl.classList.add('closed');
          return;
        }

        const st = sessionStateET(etMins, def.openET, def.closeET, def.wraps);
        maybeAlert(def.id, st.isOpen);

        if (st.isOpen){
          statusEl.textContent = 'OPEN';
          labelEl.textContent  = 'Closes in';
          timerEl.textContent  = fmtHMS(msUntilFromET(etSecs, (st.nextChangeMin - etMins + 1440) % 1440));
          const total = (st.windowEnd - st.windowStart + 1440) % 1440 || 1440;
          const done  = (etMins - st.windowStart + 1440) % 1440;
          if (fillEl) fillEl.style.width = `${(Math.min(done, total)/total*100).toFixed(2)}%`;
          cardEl.classList.remove('closed');
        } else {
          statusEl.textContent = 'CLOSED';
          labelEl.textContent  = 'Opens in';
          timerEl.textContent  = fmtHMS(msUntilFromET(etSecs, (st.nextChangeMin - etMins + 1440) % 1440));
          const total = (st.nextChangeMin - st.prevChangeMin + 1440) % 1440 || 1440;
          const done  = (etMins - st.prevChangeMin + 1440) % 1440;
          if (fillEl) fillEl.style.width = `${(Math.min(done, total)/total*100).toFixed(2)}%`;
          cardEl.classList.add('closed');
        }
      }

      // FX cards
      SESSIONS_ET.forEach(s => renderCard(s, weekend, false));
      // Retail cards (closed on weekends and outside US trading days baseline)
      RETAIL_ET.forEach(s => renderCard(s, weekend, true));
      // Macro windows (weekdays only)
      MACRO_WINDOWS.forEach(s => renderCard(s, weekend, true));
    }

    updateUI();
    setInterval(updateUI, 1000);

    // Test Sound button
    document.getElementById('testSoundBtn').addEventListener('click', async () => {
      await resumeAudioCtx();
      chimeOpen();
      setTimeout(() => beepClose(), 1000);
    });
  </script>
</body>
</html>
